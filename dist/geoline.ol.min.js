function stma_openlayers(){var g=null,i=null,n=null,l=null,o=null,h=function(){l==null&&$.ajax({method:"POST",url:"https://gis5.stuttgart.de/geoline/geoline.config/config.aspx",data:{v:"1.1 (06.04.2020 13:34:54)",epsg:g,url:location.href},dataType:"json",async:!1,cache:!1,success:function(a){a.ags_hosts=$.map(a.ags_services,function(a){return a.ags_host});l=a},error:function(a,e){console.error("OHOH",a,e)}});return l},p=function(a,e,d,b){$.ajax({url:a+"?f=json",type:"POST",dataType:"jsonp",success:function(c){try{if(typeof c.error!=
"undefined")console.warn("Eigenschaften des Kartendienstes "+a+" konnten nicht abgerufen werden.",c.error);else{var f=new URL(a);if(jQuery.inArray(f.hostname,h().ags_hosts)>-1&&(c.copyrightText==null||c.copyrightText.length==0))c.copyrightText="© Stadtmessungsamt, LHS Stuttgart";if(f.hostname.indexOf("arcgisonline.com")>-1||f.hostname.indexOf("arcgis.com")>-1){var j=$.grep(i.getControls().getArray(),function(a){return ol.control.Attribution.prototype.isPrototypeOf(a)})[0];j.setCollapsible(!1);j.setCollapsed(!1)}if(c.currentVersion==
10.05&&c.spatialReference.latestWkid==null)switch(c.spatialReference.wkid){case 102100:c.spatialReference.latestWkid=3857}g!="EPSG:"+c.spatialReference.wkid&&g!="EPSG:"+c.spatialReference.latestWkid&&console.warn("Projektion der Karte und des Kartendienstes stimmen nicht überein. Karte: "+g+", Kartendienst: EPSG:",c.spatialReference.wkid+" / EPSG:"+c.spatialReference.latestWkid,a);c.singleFusedMapCache==!0?q(a,e,d,c,b):r(a,e,d,c,b)}}catch(k){console.error("Fehler beim Initalisieren des Layers "+a,
k)}},error:function(a,b){console.error("OHOH",a,b)}})},q=function(a,e,d,b,c){var f=[];$.each(b.tileInfo.lods,function(a,b){f.push(b.resolution)});var g=new ol.tilegrid.TileGrid({origin:[b.tileInfo.origin.x,b.tileInfo.origin.y],extent:[b.fullExtent.xmin,b.fullExtent.ymin,b.fullExtent.xmax,b.fullExtent.ymax],minZoom:0,resolutions:f,tileSize:[b.tileInfo.rows,b.tileInfo.cols]});i.getView().getProjection().getCode()!=k&&($.extend(!0,n,{resolutions:f}),i.setView(new ol.View(n)));var k;k=b.spatialReference.latestWkid!=
null?b.spatialReference.latestWkid:b.spatialReference.wkid;var m={minZoom:"0"},b={tileGrid:g,projection:ol.proj.get("EPSG:"+k),attributions:b.copyrightText,url:a+"/tile/{z}/{y}/{x}"};if(o!=null)b.tileLoadFunction=o;$.extend(!0,m,d,b);d=10;a=new URL(a);jQuery.inArray(a.hostname,h().ags_hosts)>-1&&(d=20);a={zIndex:d};m={source:new ol.source.XYZ(m)};$.extend(!0,a,e,m);e=new ol.layer.Tile(a);i.addLayer(e);typeof c=="function"&&c(e)},r=function(a,e,d,b,c){var f={params:{layers:"show:0"}},b={ratio:1,url:a,
attributions:[new ol.Attribution({html:b.copyrightText})]};$.extend(!0,f,d,b);d=40;a=new URL(a);jQuery.inArray(a.hostname,h().ags_hosts)>-1&&(d=50);a={zIndex:d};f={source:new ol.source.ImageArcGISRest(f)};$.extend(!0,a,e,f);e=new ol.layer.Image(a);i.addLayer(e);typeof c=="function"&&c(e)};this.initMap=function(a,e,d,b){ol.proj.addProjection(new ol.proj.Projection({code:"EPSG:25832",units:"m"}));ol.proj.addProjection(new ol.proj.Projection({code:"EPSG:31467",units:"m"}));g="EPSG:"+a;ol.proj.get(g)==
null&&console.error("Projektion "+g+" nicht gefunden. Es kann zu falscher Darstellung der Karte kommen");if(b!=null&&b.tileLoadFunction!=null)o=b.tileLoadFunction;if(b!=null&&b.config!=null)console.warn("Konfiguration wurde manuell gesetzt und wird nicht vom Server des Stadtmessungamtes geladen. Bitte stellen Sie sicher, dass die Konfiguration immer aktuell ist."),l=b.config;a={target:"map",controls:ol.control.defaults({attribution:!0,attributionOptions:{tipLabel:"Copyright"}})};$.extend(!0,a,e,{logo:!1,
pixelRatio:1,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});if(a.controls!=null){var c=!1;a.controls.forEach(function(a){ol.control.Attribution.prototype.isPrototypeOf(a)&&(c=!0)});c==!1&&a.controls.push(new ol.control.Attribution({tipLabel:"Copyright"}))}n=$.extend(!0,{},{center:[513785,5402232],zoom:2},d,{projection:ol.proj.get(g)});i=new ol.Map(a);$(".ol-viewport").on("contextmenu",function(a){a.preventDefault()});i.updateSize()};this.addEsriLayer=function(a,e,d,b){var c=new URL(a);
jQuery.inArray(c.hostname,h().ags_hosts)>-1?console.error("Kartendienste des Stadtmessungsamtes über die Methode addStmaEsriLayer hinzufügen"):p(a,e,d,b)};this.addStmaEsriLayer=function(a,e,d,b){p("https://"+h().ags_host+"/"+h().ags_instance+"/rest/services/"+a+"/MapServer",e,d,b)};this.addStmaBaseLayer=function(a,e,d,b){h().ags_services[a]!=null?p("https://"+h().ags_services[a].ags_host+"/"+h().ags_services[a].ags_instance+"/rest/services/"+h().ags_services[a].ags_service+"/MapServer",e,d,b):console.error("Karte '"+
a+"' nicht gefunden")};this.addPoints=function(a,e,d){for(var b=[],c=0;c<a.length;c++)b.push(new ol.Feature({geometry:new ol.geom.Point(a[c])}));a=new ol.layer.Vector({zIndex:60,source:new ol.source.Vector({features:b}),style:new ol.style.Style({image:new ol.style.Icon({anchor:[0.5,1],src:e})})});i.addLayer(a);typeof d=="function"&&d(a)};this.addStmaEsriFeatureLayer=function(a,e,d,b){var c=g.replace("EPSG:","");console.warn("_epsgCode: "+c);var f=new ol.format.EsriJSON,j=new ol.source.Vector({loader:function(b,
d,g){d="https://"+h().ags_host+"/"+h().ags_instance+"/rest/services/"+a+"/MapServer/"+e+"/query/";b={f:"json",returnGeometry:!0,spatialRel:"esriSpatialRelIntersects",geometry:encodeURIComponent('{"xmin":'+b[0]+',"ymin":'+b[1]+',"xmax":'+b[2]+',"ymax":'+b[3]+',"spatialReference":{"wkid":'+c+"}}"),geometryType:"esriGeometryEnvelope",inSR:c,outFields:"*",outSR:c};$.ajax({method:"POST",url:d,data:b,dataType:"jsonp",success:function(a){a.error?alert(a.error.message+"\n"+a.error.details.join("\n")):(a=
f.readFeatures(a,{featureProjection:g}),a.length>0&&j.addFeatures(a))}})},strategy:ol.loadingstrategy.tile(ol.tilegrid.createXYZ({tileSize:512}))}),d=new ol.layer.Vector({zIndex:60,source:j,style:d});i.addLayer(d);typeof b=="function"&&b(d)};this.getMap=function(){return i};this.getConfig=function(){return h()}};
