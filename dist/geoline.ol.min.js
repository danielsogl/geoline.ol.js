function stma_openlayers(){var e=null,g=null,l=null,m=null,f=function(){m==null&&$.ajax({method:"POST",url:"https://gis5.stuttgart.de/geoline/geoline.config/config.aspx",data:{v:"0.9 (#0.9, 30.01.2018 16:08:41)",epsg:e,url:location.href},dataType:"json",async:!1,cache:!1,success:function(b){b.ags_hosts=$.map(b.ags_services,function(b){return b.ags_host});m=b},error:function(b,d){console.error("OHOH",b,d)}});return m},n=function(b,d,c){$.ajax({url:b+"?f=json",type:"POST",dataType:"jsonp",success:function(a){try{if(typeof a.error!=
"undefined")console.warn("Eigenschaften des Kartendienstes "+b+" konnten nicht abgerufen werden.",a.error);else{var h=new URL(b);if(jQuery.inArray(h.hostname,f().ags_hosts)>-1&&(a.copyrightText==null||a.copyrightText.length==0))a.copyrightText="© Stadtmessungsamt, LHS Stuttgart";if(a.currentVersion==10.05&&a.spatialReference.latestWkid==null)switch(a.spatialReference.wkid){case 102100:a.spatialReference.latestWkid=3857}e!="EPSG:"+a.spatialReference.wkid&&e!="EPSG:"+a.spatialReference.latestWkid&&
console.warn("Projektion der Karte und des Kartendienstes stimmen nicht überein. Karte: "+e+", Kartendienst: EPSG:",a.spatialReference.wkid+" / EPSG:"+a.spatialReference.latestWkid,b);if(a.singleFusedMapCache==!0)o(b,d,c,a);else{var h={params:{layers:"show:0"}},k={ratio:1,url:b,attributions:[new ol.Attribution({html:a.copyrightText})]};$.extend(!0,h,c,k);var a=40,i=new URL(b);jQuery.inArray(i.hostname,f().ags_hosts)>-1&&(a=50);var i={zIndex:a},j={source:new ol.source.ImageArcGISRest(h)};$.extend(!0,
i,d,j);var p=new ol.layer.Image(i);g.addLayer(p)}}}catch(q){console.error("Fehler beim Initalisieren des Layers "+b,q)}},error:function(a,b){console.error("OHOH",a,b)}})},o=function(b,d,c,a){var h=[];$.each(a.tileInfo.lods,function(a,b){h.push(b.resolution)});var e=new ol.tilegrid.TileGrid({origin:[a.tileInfo.origin.x,a.tileInfo.origin.y],extent:[a.fullExtent.xmin,a.fullExtent.ymin,a.fullExtent.xmax,a.fullExtent.ymax],minZoom:0,resolutions:h,tileSize:[a.tileInfo.rows,a.tileInfo.cols]});g.getView().getProjection().getCode()!=
i&&($.extend(!0,l,{resolutions:h}),g.setView(new ol.View(l)));var i;i=a.spatialReference.latestWkid!=null?a.spatialReference.latestWkid:a.spatialReference.wkid;var j={minZoom:"0"},a={tileGrid:e,projection:ol.proj.get("EPSG:"+i),attributions:[new ol.Attribution({html:a.copyrightText})],url:b+"/tile/{z}/{y}/{x}"};$.extend(!0,j,c,a);c=10;b=new URL(b);jQuery.inArray(b.hostname,f().ags_hosts)>-1&&(c=20);b={zIndex:c};j={source:new ol.source.XYZ(j)};$.extend(!0,b,d,j);d=new ol.layer.Tile(b);g.addLayer(d)};
this.initMap=function(b,d,c){ol.proj.addProjection(new ol.proj.Projection({code:"EPSG:25832",units:"m"}));ol.proj.addProjection(new ol.proj.Projection({code:"EPSG:31467",units:"m"}));e="EPSG:"+b;ol.proj.get(e)==null&&console.error("Projektion "+e+" nicht gefunden. Es kann zu falscher Darstellung der Karte kommen");var b={target:"map"},a={logo:!1,pixelRatio:1,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0,controls:ol.control.defaults({attribution:!0,attributionOptions:{tipLabel:"Copyright"}})};
$.extend(!0,b,d,a);l=$.extend(!0,{},{center:[513785,5402232],zoom:2},c,{projection:ol.proj.get(e)});g=new ol.Map(b);$(".ol-viewport").on("contextmenu",function(a){a.preventDefault()})};this.addEsriLayer=function(b,d,c){var a=new URL(b);jQuery.inArray(a.hostname,f().ags_hosts)>-1?console.error("Kartendienste des Stadtmessungsamtes über die Methode addStmaEsriLayer hinzufügen"):n(b,d,c)};this.addStmaEsriLayer=function(b,d,c){n("https://"+f().ags_host+"/"+f().ags_instance+"/rest/services/"+b+"/MapServer",
d,c)};this.addStmaBaseLayer=function(b,d,c){f().ags_services[b]!=null?n("https://"+f().ags_services[b].ags_host+"/"+f().ags_services[b].ags_instance+"/rest/services/"+f().ags_services[b].ags_service+"/MapServer",d,c):console.error("Karte '"+b+"' nicht gefunden")};this.addPoints=function(b,d){for(var c=[],a=0;a<b.length;a++)c.push(new ol.Feature({geometry:new ol.geom.Point(b[a])}));c=new ol.layer.Vector({zIndex:60,source:new ol.source.Vector({features:c}),style:new ol.style.Style({image:new ol.style.Icon({anchor:[0.5,
1],src:d})})});g.addLayer(c)};this.addStmaEsriFeatureLayer=function(b,d,c){var a=e.replace("EPSG:","");console.warn("_epsgCode: "+a);var h=new ol.format.EsriJSON,k=new ol.source.Vector({loader:function(c,e,g){e="https://"+f().ags_host+"/"+f().ags_instance+"/rest/services/"+b+"/MapServer/"+d+"/query/";c={f:"json",returnGeometry:!0,spatialRel:"esriSpatialRelIntersects",geometry:encodeURIComponent('{"xmin":'+c[0]+',"ymin":'+c[1]+',"xmax":'+c[2]+',"ymax":'+c[3]+',"spatialReference":{"wkid":'+a+"}}"),
geometryType:"esriGeometryEnvelope",inSR:a,outFields:"*",outSR:a};$.ajax({method:"POST",url:e,data:c,dataType:"jsonp",success:function(a){a.error?alert(a.error.message+"\n"+a.error.details.join("\n")):(a=h.readFeatures(a,{featureProjection:g}),a.length>0&&k.addFeatures(a))}})},strategy:ol.loadingstrategy.tile(ol.tilegrid.createXYZ({tileSize:512}))}),c=new ol.layer.Vector({zIndex:60,source:k,style:c});g.addLayer(c)};this.getMap=function(){return g}};
